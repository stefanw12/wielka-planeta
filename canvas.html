<!DOCTYPE html>
<html>

<head>
    <style>
        html {
            background-color: black;
        }
    </style>
    <title>gra</title>
</head>

<body>
    <script src="https://code.jquery.com/jquery-2.1.0.js"></script>

    <canvas id="plotno" width="1250" height="845"></canvas>

    <script>
        // var sun = new Image();
        // var moon = new Image();
        // var earth = new Image();
        // function init() {
        // sun.src = 'canvas_sun.png';
        // moon.src = 'canvas_moon.png';
        // earth.src = 'canvas_earth.png';
        // window.requestAnimationFrame(draw);
        // }

        // function draw() {
        // var ctx = document.getElementById('plotno').getContext('2d');

        // ctx.globalCompositeOperation = 'destination-over';
        // ctx.clearRect(0, 0, 300, 300); // clear canvas

        // ctx.fillStyle = 'rgba(0, 0, 0, 0.4)';
        //     ctx.strokeStyle = 'rgba(0, 153, 255, 0.4)';
        //     ctx.save();
        //     ctx.translate(150, 150);

        //     // Earth
        //     var time = new Date();
        //     ctx.rotate(((2 * Math.PI) / 60) * time.getSeconds() + ((2 * Math.PI) / 60000) * time.getMilliseconds());
        //     ctx.translate(105, 0);
        //     ctx.fillRect(0, -12, 40, 24); // Shadow
        //     ctx.drawImage(earth, -12, -12);

        //     // Moon
        //     ctx.save();
        //     ctx.rotate(((2 * Math.PI) / 6) * time.getSeconds() + ((2 * Math.PI) / 6000) * time.getMilliseconds());
        //     ctx.translate(0, 28.5);
        //     ctx.drawImage(moon, -3.5, -3.5);
        //     ctx.restore();

        //     ctx.restore();

        //     ctx.beginPath();
        //     ctx.arc(150, 150, 105, 0, Math.PI * 2, false); // Earth orbit
        //     ctx.stroke();

        //     ctx.drawImage(sun, 0, 0, 300, 300);

        //     window.requestAnimationFrame(draw);
        //     }

        //     init();
        let startTime = Date.now();
        let plotno = document.getElementById("plotno");
        let szer = plotno.width;
        let wys = plotno.height;
        let plotnoCtx = plotno.getContext("2d");
        let graRysuj;
        let graPrzesuwaj;
        let kierunki = {
            37: "lewa",
            38: "gora",
            39: "prawa",
            40: "dol",
            32: "odswiez",
            27: "zatrzymaj"
        };
        let kierunek = "";
        let predkoscRuchu = 0.3;
        let szerokoscEkranu = 1250;
        let wysokoscEkranu = 840;
        let bufferWidth = 2000;
        let bufferHeight = 2000;
        let ekranCenterX = szerokoscEkranu / 2;
        let ekranCenterY = wysokoscEkranu / 2;
        let centerX = bufferWidth / 2;
        let centerY = bufferHeight / 2;
        let worldX = 0;
        let worldY = 0;
        let koniecGry = false;

        let bufferCanvas = document.createElement("canvas");
        bufferCanvas.width = bufferWidth;
        bufferCanvas.height = bufferHeight;
        let ctx = bufferCanvas.getContext("2d");
        let reqId;

        let usun = function (obiekt, lista) {
            let obiektDoUsuniecia = lista.indexOf(obiekt);
            lista.splice(obiektDoUsuniecia, 1);
        }

        let wyswietltekst = function (tekst, rozmiar, x, y) {
            ctx.font = `${rozmiar}px Courier`;
            ctx.textAlign = "left";
            ctx.textBaseline = "top";
            ctx.fillStyle = "White";
            ctx.fillText(tekst, x, y);
        };

        function odswiez() {
            window.location.reload(true);
        };

        function wlaczMenu () {
            wyswietltekst("HEJ", 1000, ekranCenterX, ekranCenterY)
        }

        let Planeta = function (x, y, rozmiar) {
            this.x = x;
            this.y = y;
            this.planetaRozmiar = rozmiar;
        };

        let okrag = function (x, y, kolor, promien, wypelnijOkrag) {
            ctx.beginPath();
            ctx.arc(x, y, promien, 0, Math.PI * 2, false);
            if (wypelnijOkrag) {
                ctx.fillStyle = kolor;
                ctx.fill();
            } else {
                ctx.stroke();
            }
        };

        let gwiazdka = function (x, y, scale) {
            ctx.save();
            ctx.fillStyle = "white";
            ctx.translate(x, y);
            ctx.transform(scale, 0, 0, scale, 0, 0);
            ctx.beginPath();
            ctx.moveTo(30, 0);
            ctx.lineTo(20, 20);
            ctx.lineTo(0, 20);
            ctx.lineTo(20, 40);
            ctx.lineTo(10, 60);
            ctx.lineTo(30, 50);
            ctx.lineTo(50, 60);
            ctx.lineTo(40, 40);
            ctx.lineTo(60, 20);
            ctx.lineTo(40, 20);
            ctx.fill();
            ctx.restore();
        }

        Planeta.prototype.rysuj = function () {
            ctx.save();
            let szerokoscPaska = 20;
            let iloscPaskow = Math.ceil(this.planetaRozmiar / szerokoscPaska);
            for (let i = 0; i < iloscPaskow; i++) {
                let rozmiar = this.planetaRozmiar - i * szerokoscPaska;
                let kolor = i % 2 == 0 ? "Brown" : "Orange";
                okrag(this.x, this.y, kolor, rozmiar, true);
            }
            ctx.restore();
        };

        Planeta.prototype.przesun = function (kierunek, timeDiff) {
            asteroidy.forEach(element => {
                if (this.sprawdzKolizje(this.x, this.y, this.planetaRozmiar, element.x, element.y, element.rozmiar)
                    && this.planetaRozmiar > element.rozmiar) {
                    this.planetaRozmiar += element.rozmiar / 3;
                    usun(element, asteroidy);
                }
            });

            ksiezyce.forEach(element => {
                if (this.sprawdzKolizje(this.x, this.y, this.planetaRozmiar, element.x, element.y, element.rozmiar)
                    && this.planetaRozmiar > element.rozmiar) {
                    this.planetaRozmiar += element.rozmiar / 5;
                    usun(element, ksiezyce);
                }
            });

            planety.forEach(element => {
                if (this.sprawdzKolizje(this.x, this.y, this.planetaRozmiar, element.x, element.y, element.planetaRozmiar)
                    && this.planetaRozmiar > element.planetaRozmiar) {
                    this.planetaRozmiar += element.planetaRozmiar / 6;
                    usun(element, planety);
                }
            });

            gwiazdy.forEach(element => {
                if (this.sprawdzKolizje(this.x, this.y, this.planetaRozmiar, element.x, element.y, element.rozmiar)
                    && this.planetaRozmiar > element.rozmiar && asteroidy.length === 0 & ksiezyce.length === 0 & planety.length === 0) {
                    this.planetaRozmiar += 200;
                    usun(element, gwiazdy);
                }
            });

            if (!this.sprawdzCzyJestesWiekszyOdSceny()) {
                if (kierunek === "gora") {
                    this.y -= predkoscRuchu * timeDiff;
                } else if (kierunek === "dol") {
                    this.y += predkoscRuchu * timeDiff;
                } else if (kierunek === "prawa") {
                    this.x += predkoscRuchu * timeDiff;
                } else if (kierunek === "lewa") {
                    this.x -= predkoscRuchu * timeDiff;
                }
            } else {
                window.cancelAnimationFrame(reqId);
                wyswietltekst("Jesteś większy od sceny!", 650, ekranCenterX, ekranCenterY);
                wyswietltekst("Poczekaj chiwle na odświeżenie...", 500, ekranCenterX, ekranCenterY + 670);
                return "Tak"
            }
            if (kierunek === "odswiez") {
                odswiez();
            }

            if (kierunek === "zatrzymaj") {
                //if (koniecGry = false) {
                    koniecGry = true;
                    wlaczMenu();
                /*} else {
                    koniecgry = false;
                }*/
            }
        };

        Planeta.prototype.sprawdzKolizje = function (x, y, promien, drugiObjektX, drugiObjektY, drugiObjektPromien) {
            return Math.sqrt(Math.pow(x - drugiObjektX, 2) + Math.pow(y - drugiObjektY, 2)) < promien + drugiObjektPromien;
        };

        Planeta.prototype.sprawdzCzyJestesWiekszyOdSceny = function () {
            return gwiazdy.length === 0
        };

        let Asteroida = function (x, y, rozmiar, predkosc) {
            this.x = x;
            this.y = y;
            this.rozmiar = rozmiar;
        };

        Asteroida.prototype.rysuj = function () {
            ctx.save();
            okrag(this.x, this.y, "gray", this.rozmiar, true);
            ctx.restore();
        };

        Asteroida.prototype.przesun = function () {
            this.y += 10;
            if (this.y < wys) {
                usun(this, asteroidy);
            }
        };

        function pointInCircle(x1, y1, x2, y2, rozmiar, rozmiar2) {
            return Math.sqrt(Math.pow(x1 - x2, 2) + Math.pow(y1 - y2, 2)) < rozmiar + rozmiar2;
        }

        let generujAsteroide = function () {
            let newX = 0;
            let newY = 0;
            let kolizjaKsiezyce = false;
            let kolizjaAsteroidy = false;
            let kolizjaGwiazdy = false;
            let kolizjaPlanety = false;
            let rozmiar = Math.floor(Math.random() * 50);
            do {
                newX = Math.floor(Math.random() * bufferWidth);
                newY = Math.floor(Math.random() * bufferHeight);
                kolizjaKsiezyce = ksiezyce.some(ksiezyc => {
                    return pointInCircle(newX, newY, ksiezyc.x, ksiezyc.y, ksiezyc.rozmiar, rozmiar);
                });
                kolizjaAsteroidy = asteroidy.some(asteroida => {
                    return pointInCircle(newX, newY, asteroida.x, asteroida.y, asteroida.rozmiar, rozmiar);
                });
                kolizjaGwiazdy = gwiazdy.some(gwiazda => {
                    return pointInCircle(newX, newY, gwiazda.x, gwiazda.y, gwiazda.rozmiar, rozmiar);
                });
                kolizjaPlanety = planety.some(planeta => {
                    return pointInCircle(newX, newY, planeta.x, planeta.y, planeta.rozmiar, rozmiar);
                });
            } while (kolizjaKsiezyce || kolizjaAsteroidy || kolizjaPlanety || kolizjaGwiazdy);
            let asteroida = new Asteroida(newX, newY, rozmiar, Math.floor(Math.random() * 50));
            return asteroida;
        };

        let Ksiezyc = function (x, y) {
            this.rozmiar = Math.floor(50 + Math.random() * 50);
            this.x = x;
            this.y = y;
        };

        Ksiezyc.prototype.rysuj = function () {
            ctx.save();
            this.czyMozeBycTenRiozmair = this.rozmiar - 5 > 50 ? 5 : 0;
            okrag(this.x, this.y, "gray", this.rozmiar, true);
            okrag(this.x - 20, this.y - 23, "black", this.rozmiar / 4 + 3, true);
            okrag(this.x + 20, this.y + 33, "black", this.rozmiar / 5 + 1, true);
            okrag(this.x + 35, this.y - 27, "black", this.rozmiar / 5 - 7, true);
            okrag(this.x - 35, this.y + 33, "black", this.rozmiar / 5 - 7, true);
            ctx.restore();
        };

        let generujKsieżyc = function () {
            let newX = 0;
            let newY = 0;
            let kolizjaKsiezyce = false;
            let kolizjaGwiazdy = false;
            let kolizjaPlanety = false;
            let rozmiar = Math.floor(50 + Math.random() * 50);
            do {
                newX = Math.floor(Math.random() * bufferWidth);
                newY = Math.floor(Math.random() * bufferHeight);
                kolizjaKsiezyce = ksiezyce.some(ksiezyc => {
                    return pointInCircle(newX, newY, ksiezyc.x, ksiezyc.y, ksiezyc.rozmiar, rozmiar);
                });
                kolizjaGwiazdy = gwiazdy.some(gwiazda => {
                    return pointInCircle(newX, newY, gwiazda.x, gwiazda.y, gwiazda.rozmiar, rozmiar);
                });
                kolizjaPlanety = planety.some(planeta => {
                    return pointInCircle(newX, newY, planeta.x, planeta.y, planeta.rozmiar, rozmiar);
                });
            } while (kolizjaKsiezyce || kolizjaGwiazdy || kolizjaPlanety);
            let ksiezyc = new Ksiezyc(newX, newY, rozmiar, Math.floor(50 + Math.random() * 50));
            return ksiezyc;
        };

        let Gwiazda = function () {
            this.x = centerX;
            this.y = centerY;
            this.rozmiar = Math.floor(250 + Math.random() * 50);
        };

        Gwiazda.prototype.rysuj = function () {
            ctx.save();
            okrag(this.x, this.y, "yellow", this.rozmiar, true);
            ctx.restore();
        };

        let planeta = new Planeta(ekranCenterX - 500, ekranCenterY, 50);

        let generujPlanete = function () {
            let newX = 0;
            let newY = 0;
            let kolizjaGwiazdy = false;
            let kolizjaPlanety = false;
            let rozmiar = Math.floor(100 + Math.random() * 50);
            do {
                newX = Math.floor(Math.random() * bufferWidth);
                newY = Math.floor(Math.random() * bufferHeight);
                kolizjaGwiazdy = gwiazdy.some(gwiazda => {
                    return pointInCircle(newX, newY, gwiazda.x, gwiazda.y, gwiazda.rozmiar, rozmiar);
                });
                kolizjaPlanety = planety.some(planeta => {
                    return pointInCircle(newX, newY, planeta.x, planeta.y, planeta.rozmiar, rozmiar);
                });
            } while (kolizjaGwiazdy || kolizjaPlanety);
            let planeta = new Planeta(newX, newY, rozmiar, Math.floor(50 + Math.random() * 50));
            return planeta;
        };

        let gwiazda = new Gwiazda();
        let gwiazdy = [gwiazda];

        let planety = [];
        for (let i = 0; i < 10; i++) {
            planety.push(generujPlanete());
        }

        let ksiezyce = [];
        for (let i = 0; i < 10; i++) {
            ksiezyce.push(generujKsieżyc());
        }

        let asteroidy = [];
        for (let i = 0; i < 10; i++) {
            asteroidy.push(generujAsteroide());
        }

        let asteroidyKopia = asteroidy;

        let najWiekszyPlanetaRozmiar = null;

        $("body").keydown(function (zdarzenie) {
            kierunek = kierunki[zdarzenie.keyCode];
        });

        $("body").keyup(function (zdarzenie) {
            kierunek = "";
        });

        function ensureVehicleInBounds() {
            if (planeta.x < planeta.planetaRozmiar) {
                planeta.x = planeta.planetaRozmiar;
            } else if (planeta.x > bufferWidth - planeta.planetaRozmiar) {
                planeta.x = bufferWidth - planeta.planetaRozmiar;
            }

            if (planeta.y < planeta.planetaRozmiar) {
                planeta.y = planeta.planetaRozmiar;
            } else if (planeta.y > bufferHeight - planeta.planetaRozmiar) {
                planeta.y = bufferHeight - planeta.planetaRozmiar;
            }
        }

        function updateWorldCoords() {
            if (planeta.x > ekranCenterX && planeta.x < bufferWidth - ekranCenterX) {
                worldX = -planeta.x + ekranCenterX;
            } else if (planeta.x <= ekranCenterX) {
                worldX = 0;
            } else if (planeta.x > szerokoscEkranu - ekranCenterX) {
                worldX = -bufferWidth + ekranCenterX * 2;
            }
            if (planeta.y > ekranCenterY && planeta.y < bufferHeight - ekranCenterY) {
                worldY = -planeta.y + ekranCenterY;
            } else if (planeta.y <= ekranCenterY) {
                worldY = 0;
            } else if (planeta.y > bufferHeight - ekranCenterY) {
                worldY = -bufferHeight + ekranCenterY * 2;
            }
        }

        let gra = function (lastTime) {
            let time = Date.now();
            let timeDiff = time - lastTime;

            planeta.przesun(kierunek, timeDiff);
            ensureVehicleInBounds();
            updateWorldCoords();

            ctx.clearRect(0, 0, bufferWidth, bufferHeight);

            ctx.save();
            ctx.fillStyle = "Black";
            ctx.restore();

            gwiazdka(50, 50, 0.7);
            gwiazdka(500, 300, 1.2);

            for (let i = 0; i < gwiazdy.length; i++) {
                gwiazdy[i].rysuj();
            }

            for (let i = 0; i < planety.length; i++) {
                planety[i].rysuj();
            }

            for (let i = 0; i < ksiezyce.length; i++) {
                ksiezyce[i].rysuj();
            }

            for (let i = 0; i < asteroidy.length; i++) {
                asteroidy[i].rysuj();
            }

            planeta.rysuj();

            plotnoCtx.clearRect(0, 0, plotno.width, plotno.height);
            plotnoCtx.drawImage(bufferCanvas, worldX, worldY);
            if (!koniecGry) {
                reqId = window.requestAnimationFrame(function () {
                    gra(time);
                });

            }
        };

        gra(startTime);

        setInterval(function () {
            asteroidy.forEach(element => {
                element.przesun();
            });
        }, 700);
    </script>
</body>

</html>